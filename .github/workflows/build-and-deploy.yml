name: Build and Deploy Documentation

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master

jobs:
  build:
    name: Build Docusaurus Site
    # Use Linux for faster build times and better npm caching performance
    # Windows is not required for Node.js builds
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build documentation
        run: npm run build

      - name: Upload build artifacts
        if: github.event_name == 'push' && github.ref == 'refs/heads/master'
        uses: actions/upload-artifact@v4
        with:
          name: docusaurus-build
          path: build/
          retention-days: 1

  deploy:
    name: Deploy to Staging Servers
    needs: build
    if: github.event_name == 'push' && github.ref == 'refs/heads/master'
    # Must use Windows runner for deployment because:
    # 1. Target servers are Windows machines on an internal network
    # 2. Requires native Windows authentication (PSDrive with credentials)
    # 3. Uses Robocopy which is Windows-only
    # 4. Linux cannot reliably authenticate to Windows network shares in this environment
    runs-on: windows-latest
    
    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: docusaurus-build
          path: build/

      - name: Deploy to S0106WEB6S
        shell: powershell
        env:
          USERNAME: ${{ secrets.TFSBUILD_USER_NAME }}
          PASSWORD: ${{ secrets.TFSBUILD_USER_PASSWORD }}
        run: |
          # Create credential object
          $securePassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential($env:USERNAME, $securePassword)
          
          # Map network drive temporarily
          $server1 = "\\S0106WEB6S.igweb.local"
          $targetPath1 = "$server1\websites\revealbi.io\help-staging"
          
          Write-Host "Connecting to $server1..."
          New-PSDrive -Name "DeployDrive1" -PSProvider FileSystem -Root $server1 -Credential $credential -ErrorAction Stop
          
          try {
            # Clean the staging directory
            Write-Host "Cleaning staging directory on S0106WEB6S..."
            if (Test-Path $targetPath1) {
              Remove-Item -Path "$targetPath1\*" -Recurse -Force -ErrorAction Stop
            } else {
              New-Item -Path $targetPath1 -ItemType Directory -Force
            }
            
            # Copy files using Robocopy
            Write-Host "Deploying to S0106WEB6S..."
            robocopy "build" $targetPath1 /E /Z /R:3 /W:5 /MT:8 /NFL /NDL /NP
            
            # Robocopy exit codes: 0-7 are success, 8+ are errors
            if ($LASTEXITCODE -ge 8) {
              Write-Error "Robocopy failed with exit code $LASTEXITCODE"
              exit 1
            }
            
            Write-Host "Successfully deployed to S0106WEB6S"
          }
          finally {
            # Clean up drive mapping
            Remove-PSDrive -Name "DeployDrive1" -Force -ErrorAction SilentlyContinue
          }

      - name: Deploy to S0106WEB7S
        shell: powershell
        env:
          USERNAME: ${{ secrets.TFSBUILD_USER_NAME }}
          PASSWORD: ${{ secrets.TFSBUILD_USER_PASSWORD }}
        run: |
          # Create credential object
          $securePassword = ConvertTo-SecureString $env:PASSWORD -AsPlainText -Force
          $credential = New-Object System.Management.Automation.PSCredential($env:USERNAME, $securePassword)
          
          # Map network drive temporarily
          $server2 = "\\S0106WEB7S.igweb.local"
          $targetPath2 = "$server2\websites\revealbi.io\help-staging"
          
          Write-Host "Connecting to $server2..."
          New-PSDrive -Name "DeployDrive2" -PSProvider FileSystem -Root $server2 -Credential $credential -ErrorAction Stop
          
          try {
            # Clean the staging directory
            Write-Host "Cleaning staging directory on S0106WEB7S..."
            if (Test-Path $targetPath2) {
              Remove-Item -Path "$targetPath2\*" -Recurse -Force -ErrorAction Stop
            } else {
              New-Item -Path $targetPath2 -ItemType Directory -Force
            }
            
            # Copy files using Robocopy
            Write-Host "Deploying to S0106WEB7S..."
            robocopy "build" $targetPath2 /E /Z /R:3 /W:5 /MT:8 /NFL /NDL /NP
            
            # Robocopy exit codes: 0-7 are success, 8+ are errors
            if ($LASTEXITCODE -ge 8) {
              Write-Error "Robocopy failed with exit code $LASTEXITCODE"
              exit 1
            }
            
            Write-Host "Successfully deployed to S0106WEB7S"
          }
          finally {
            # Clean up drive mapping
            Remove-PSDrive -Name "DeployDrive2" -Force -ErrorAction SilentlyContinue
          }

      - name: Deployment Summary
        if: success()
        run: |
          Write-Host "âœ… Documentation successfully deployed to both staging servers:"
          Write-Host "   - S0106WEB6S.igweb.local"
          Write-Host "   - S0106WEB7S.igweb.local"
